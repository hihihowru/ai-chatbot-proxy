# 個股分析流程 - OpenAI API 調用詳解

## 流程概述

個股分析流程是系統的核心功能，當用戶詢問特定股票時（如"台積電怎麼樣？"），系統會執行完整的分析流程，包含意圖理解、資料搜尋、新聞分析、報告生成等步驟。

## 使用的 GPT Model

**主要模型**: `gpt-3.5-turbo`
- 成本: $0.01/次 (約 $0.002/1K tokens)
- 用途: 意圖分類、內容生成、報告撰寫
- 溫度設定: 0-0.3 (確保一致性)

## 完整流程與 API 調用

### 1. 問題理解與分類階段
**API 調用次數**: 1 次 OpenAI API

**節點**: `classify_and_extract`
- **目的**: 理解用戶問題意圖，提取關鍵資訊
- **輸入**: 用戶原始問題
- **輸出**: 分類結果、股票代號、時間資訊、關鍵字
- **Prompt**: 金融語意分類專家 prompt
- **模型**: `gpt-3.5-turbo`
- **溫度**: 0

**範例輸入**: "台積電最近怎麼樣？"
**範例輸出**:
```json
{
  "category": "個股分析",
  "subcategory": ["綜合分析"],
  "view_type": ["沒有特別"],
  "keywords": ["台積電", "最近"],
  "company_name": "台積電",
  "stock_id": "2330",
  "time_info": "最近",
  "event_type": "其他"
}
```

### 2. 新聞搜尋階段
**API 調用次數**: 8-12 次 Serper API (非 OpenAI)

**節點**: `search_news`
- **目的**: 搜尋相關新聞和市場資訊
- **輸入**: 股票代號、公司名稱、關鍵字
- **輸出**: 新聞摘要、來源連結
- **API**: Serper Search API
- **成本**: $0.003/次

**搜尋策略**:
- 生成 8-12 個搜尋關鍵字
- 每個關鍵字調用 1 次 Serper API
- 關鍵字範例: "台積電 2330 財報", "台積電 外資買賣", "2330 法人動向" 等

### 3. 新聞摘要生成階段
**API 調用次數**: 1 次 OpenAI API

**節點**: `summarize_results`
- **目的**: 將搜尋結果整理成摘要
- **輸入**: 新聞搜尋結果
- **輸出**: 結構化摘要
- **模型**: `gpt-3.5-turbo`
- **溫度**: 0

### 4. 最終報告生成階段
**API 調用次數**: 1 次 OpenAI API

**節點**: `generate_report`
- **目的**: 生成完整的投資分析報告
- **輸入**: 所有前期分析結果
- **輸出**: 結構化投資報告
- **模型**: `gpt-3.5-turbo`
- **溫度**: 0.3 (增加創意性)

## 總計 API 調用

| 階段 | OpenAI API | Serper API | 目的 |
|------|------------|------------|------|
| 問題理解 | 1 次 | - | 意圖分類與資訊提取 |
| 新聞搜尋 | - | 8-12 次 | 相關新聞搜尋 |
| 新聞摘要 | 1 次 | - | 搜尋結果摘要 |
| 報告生成 | 1 次 | - | 最終分析報告 |
| **總計** | **3 次** | **8-12 次** | **完整分析流程** |

## 成本分析

### OpenAI API 成本
- **每次調用**: $0.01
- **總成本**: 3 × $0.01 = $0.03

### Serper API 成本
- **每次調用**: $0.003
- **總成本**: 10 × $0.003 = $0.03 (平均)

### 總成本
- **個股分析總成本**: $0.06/次

## 流程圖

```
用戶問題 → 問題理解(1次GPT) → 新聞搜尋(8-12次Serper) → 新聞摘要(1次GPT) → 報告生成(1次GPT) → 完整報告
```

## 優化策略

### 1. 快取機制
- 相同股票的分析結果可快取 1-2 小時
- 減少重複 API 調用

### 2. 並行處理
- 新聞搜尋和資料查詢可並行執行
- 縮短總處理時間

### 3. 智能路由
- 根據問題複雜度決定是否需要所有步驟
- 簡單問題可跳過部分步驟

## 錯誤處理

### API 失敗處理
1. **OpenAI API 失敗**: 使用備用回應模板
2. **Serper API 失敗**: 跳過新聞搜尋，使用基本分析
3. **部分失敗**: 繼續執行其他步驟，標註缺失資訊

### 降級策略
- 完整分析 → 基本分析 → 簡單回應
- 確保用戶總能得到有用資訊

## 監控指標

### 效能指標
- **平均回應時間**: 10-15 秒
- **成功率**: >95%
- **API 成本**: $0.06/次

### 品質指標
- **用戶滿意度**: 基於後續互動
- **報告完整性**: 包含所有必要資訊
- **資訊準確性**: 定期人工審查

## 擴展性

### 新增分析維度
- 技術分析: +1 次 OpenAI API
- 財務分析: +1 次 OpenAI API
- 籌碼分析: +1 次 OpenAI API

### 成本控制
- 設定每日 API 使用限制
- 實時成本監控
- 自動降級機制 