# 自選股摘要分析流程 - OpenAI API 調用詳解

## 流程概述

自選股摘要分析流程是系統的進階功能，當用戶匯入自選股清單時，系統會對整個投資組合進行全面分析，包含產業分布、股價表現、報酬率統計、焦點個股等多元維度分析。

## 使用的 GPT Model

**主要模型**: `gpt-3.5-turbo`
- 成本: $0.01/次 (約 $0.002/1K tokens)
- 用途: 資料分析、報告生成、洞察提取
- 溫度設定: 0-0.3 (確保分析一致性)

## 完整流程與 API 調用

### 1. 產業分布統計階段
**API 調用次數**: 1 次 OpenAI API

**節點**: `generate_section_industry_distribution`
- **目的**: 分析自選股的產業分布情況
- **輸入**: 股票代號清單
- **輸出**: 產業分布統計、各產業檔數
- **資料來源**: FinLab company_basic_info
- **模型**: `gpt-3.5-turbo`
- **溫度**: 0

**範例輸入**: `[2330, 2454, 2317, 2303, 2610]`
**範例輸出**:
```json
{
  "title": "產業分布統計",
  "content": "🏷 產業分布統計\n\t•\t電子（半導體、PC）：3 檔\n\t•\t航運：1 檔\n\t•\t其他：1 檔",
  "cards": [...],
  "sources": [...]
}
```

### 2. 產業比較分析階段
**API 調用次數**: 1 次 OpenAI API

**節點**: `generate_section_industry_comparison`
- **目的**: 比較不同產業的表現
- **輸入**: 產業分布資料
- **輸出**: 產業比較分析
- **模型**: `gpt-3.5-turbo`
- **溫度**: 0

### 3. 股價表現分析階段
**API 調用次數**: 1 次 OpenAI API

**節點**: `generate_section_price_movement`
- **目的**: 分析各股票的價格變動
- **輸入**: 股票代號清單、價格資料
- **輸出**: 價格表現統計、漲跌排行
- **資料來源**: FinLab price_data
- **模型**: `gpt-3.5-turbo`
- **溫度**: 0

### 4. 報酬率統計階段
**API 調用次數**: 1 次 OpenAI API

**節點**: `generate_section_return_analysis`
- **目的**: 計算投資組合報酬率
- **輸入**: 價格資料、持有期間
- **輸出**: 報酬率統計、風險指標
- **模型**: `gpt-3.5-turbo`
- **溫度**: 0

### 5. 焦點個股分析階段
**API 調用次數**: 2-3 次 OpenAI API

**節點**: `generate_section_focus_stocks`
- **目的**: 識別和分析焦點個股
- **輸入**: 所有股票資料
- **輸出**: 焦點個股清單、分析理由
- **模型**: `gpt-3.5-turbo`
- **溫度**: 0.3

**分析維度**:
- 漲幅最大/最小股票
- 成交量異常股票
- 基本面變化股票

### 6. 新聞搜尋階段
**API 調用次數**: 8-12 次 Serper API (非 OpenAI)

**節點**: `search_news_grouped`
- **目的**: 搜尋投資組合相關新聞
- **輸入**: 股票清單、產業資訊
- **輸出**: 相關新聞摘要
- **API**: Serper Search API
- **成本**: $0.003/次

**搜尋策略**:
- 為每個產業生成 2-3 個關鍵字
- 為焦點個股生成專屬關鍵字
- 總計 8-12 個搜尋關鍵字

### 7. 新聞摘要生成階段
**API 調用次數**: 1 次 OpenAI API

**節點**: `summarize_watchlist_news`
- **目的**: 整理投資組合相關新聞
- **輸入**: 新聞搜尋結果
- **輸出**: 投資組合新聞摘要
- **模型**: `gpt-3.5-turbo`
- **溫度**: 0

### 8. 最終報告整合階段
**API 調用次數**: 1 次 OpenAI API

**節點**: `generate_watchlist_summary`
- **目的**: 整合所有分析結果
- **輸入**: 所有分析階段結果
- **輸出**: 完整投資組合報告
- **模型**: `gpt-3.5-turbo`
- **溫度**: 0.3

## 總計 API 調用

| 階段 | OpenAI API | Serper API | 目的 |
|------|------------|------------|------|
| 產業分布統計 | 1 次 | - | 產業分布分析 |
| 產業比較分析 | 1 次 | - | 產業表現比較 |
| 股價表現分析 | 1 次 | - | 價格變動統計 |
| 報酬率統計 | 1 次 | - | 投資報酬分析 |
| 焦點個股分析 | 2-3 次 | - | 重點股票識別 |
| 新聞搜尋 | - | 8-12 次 | 相關新聞搜尋 |
| 新聞摘要 | 1 次 | - | 新聞內容整理 |
| 報告整合 | 1 次 | - | 最終報告生成 |
| **總計** | **8-9 次** | **8-12 次** | **完整投資組合分析** |

## 成本分析

### OpenAI API 成本
- **每次調用**: $0.01
- **總成本**: 8.5 × $0.01 = $0.085 (平均)

### Serper API 成本
- **每次調用**: $0.003
- **總成本**: 10 × $0.003 = $0.03 (平均)

### 總成本
- **自選股摘要總成本**: $0.115/次

## 流程圖

```
股票清單 → 產業分析(2次GPT) → 股價分析(2次GPT) → 焦點個股(2-3次GPT) → 新聞搜尋(8-12次Serper) → 新聞摘要(1次GPT) → 報告整合(1次GPT) → 完整投資組合報告
```

## 資料來源

### FinLab API 資料
- **company_basic_info**: 公司基本資訊、產業分類
- **price_data**: 股價資料、成交量
- **financial_data**: 財務指標、營收資料

### 外部資料
- **新聞搜尋**: 18 個財經網站
- **市場資料**: 即時股價、成交量

## 優化策略

### 1. 並行處理
- 產業分析、股價分析可並行執行
- 新聞搜尋可與其他分析並行
- 縮短總處理時間至 20-25 秒

### 2. 快取機制
- 相同股票組合可快取 30 分鐘
- 產業分類資料可快取 24 小時
- 減少重複 API 調用

### 3. 智能路由
- 根據股票數量調整分析深度
- 小於 5 檔股票可簡化分析
- 大於 20 檔股票可分批處理

## 錯誤處理

### API 失敗處理
1. **FinLab API 失敗**: 使用快取資料或跳過該分析
2. **OpenAI API 失敗**: 使用預設分析模板
3. **Serper API 失敗**: 跳過新聞搜尋

### 降級策略
- 完整分析 → 基本統計 → 簡單列表
- 確保用戶總能得到投資組合概覽

## 監控指標

### 效能指標
- **平均回應時間**: 25-35 秒
- **成功率**: >90%
- **API 成本**: $0.115/次

### 品質指標
- **分析完整性**: 包含所有必要維度
- **資料準確性**: 與實際市場資料比對
- **用戶滿意度**: 基於後續互動

## 擴展性

### 新增分析維度
- 風險分析: +1 次 OpenAI API
- 技術分析: +1 次 OpenAI API
- 基本面分析: +1 次 OpenAI API

### 成本控制
- 設定每日 API 使用限制
- 實時成本監控
- 自動降級機制

## 使用場景

### 適用情況
- 投資組合定期檢視
- 新股票加入後重新評估
- 市場波動時快速分析
- 投資決策前全面評估

### 建議使用頻率
- **每日**: 5 檔以下小組合
- **每週**: 10-20 檔中等組合
- **每月**: 20 檔以上大組合 