# main.py - 系統主架構

## 系統概述

`main.py` 是台股投資分析助理系統的核心入口，基於 FastAPI 框架構建，提供完整的投資分析服務。系統整合了多個專業模組，能夠處理複雜的投資問題並提供結構化的分析報告。

## 系統架構

### 核心組件
```
FastAPI 應用程式
├── 問題理解模組 (classify_and_extract)
├── 股票偵測模組 (detect_stocks)
├── 時間偵測模組 (detect_time)
├── 圖表偵測模組 (detect_chart)
├── 新聞搜尋模組 (search_news_smart)
├── 報告生成模組 (generate_report_pipeline)
├── 資料庫查詢模組 (database_query)
└── WebSocket 即時通訊
```

### 技術棧
- **後端框架**：FastAPI
- **AI 模型**：OpenAI GPT-3.5-turbo
- **資料來源**：Finlab、Serper API、Yahoo Finance
- **即時通訊**：WebSocket、Server-Sent Events (SSE)
- **跨域支援**：CORS Middleware

## 主要功能

### 1. 智能問題理解
- **股票代號偵測**：自動識別問題中的股票代號和公司別名
- **時間表達解析**：理解「今天」、「上週」、「最近一個月」等時間詞彙
- **意圖分類**：將問題分類為個股分析、選股建議、盤勢分析等類型
- **投資面向判斷**：識別基本面、技術面、籌碼面等投資面向

### 2. 多源資料整合
- **新聞搜尋**：從 17 個台股財經網站搜尋相關新聞
- **財務資料**：從 Finlab 取得財務指標和歷史資料
- **即時資訊**：從 Yahoo Finance 取得即時股價和財務資料
- **圖表資料**：支援多種圖表類型的資料查詢

### 3. 智能分析報告
- **結構化報告**：生成包含多個 section 的完整分析報告
- **模組化設計**：每個分析面向都是獨立的模組，可動態組合
- **即時生成**：支援 SSE 即時顯示分析進度
- **多格式輸出**：支援文字、表格、圖表等多種呈現方式

## API 端點

### 核心分析 API

#### `POST /api/ask`
- **功能**：基礎股票代號偵測
- **輸入**：`{"question": "問題內容"}`
- **輸出**：`{"stock_ids": ["2330", "2303"]}`

#### `POST /api/ask-logs`
- **功能**：詳細偵測過程日誌
- **輸入**：`{"question": "問題內容"}`
- **輸出**：`{"logs": ["🔍 開始偵測股票代號...", "✅ 偵測到股票代號：2330"]}`

#### `GET /api/ask-sse`
- **功能**：SSE 即時分析流程
- **參數**：`question=問題內容`
- **輸出**：即時串流分析進度和結果

#### `POST /api/investment-analysis`
- **功能**：完整投資分析
- **輸入**：`{"question": "問題內容", "serper_api_key": "可選"}`
- **輸出**：完整的投資分析報告

#### `GET /api/investment-analysis-sse`
- **功能**：SSE 即時投資分析
- **參數**：`question=問題內容&serper_api_key=可選`
- **輸出**：即時串流分析報告

### 資料庫查詢 API

#### `POST /api/query-database`
- **功能**：資料庫查詢
- **輸入**：`{"intent_category": "類別", "investment_aspect": "面向", "stock_ids": ["2330"]}`
- **輸出**：結構化資料庫查詢結果

#### `POST /api/query-chart`
- **功能**：圖表資料查詢
- **輸入**：`{"stock_ids": ["2330"], "chart_type": "圖表類型"}`
- **輸出**：圖表資料

### 代理 API

#### `POST /api/proxy_login`
- **功能**：代理登入請求
- **用途**：處理第三方服務的登入驗證

#### `POST /api/proxy_custom_group`
- **功能**：代理自選股群組請求
- **用途**：處理自選股相關的 API 調用

### WebSocket API

#### `GET /ws/ask`
- **功能**：WebSocket 即時通訊
- **用途**：支援即時對話和分析進度更新

## 設計理念

### 1. 模組化架構
- **獨立模組**：每個功能都是獨立的模組，便於維護和擴充
- **鬆耦合設計**：模組間通過標準化介面通信
- **可插拔性**：可以輕鬆替換或新增模組

### 2. 即時性設計
- **多種即時通訊**：支援 SSE 和 WebSocket
- **進度回饋**：用戶可以看到分析進度
- **流式輸出**：避免長時間等待

### 3. 錯誤處理
- **容錯機制**：單一模組失敗不影響整體流程
- **降級策略**：當主要資料來源失敗時，使用備用方案
- **詳細日誌**：完整的錯誤追蹤和調試資訊

### 4. 擴充性
- **API 設計**：RESTful API 設計，易於整合
- **資料來源**：支援多個資料來源，可輕鬆新增
- **分析模組**：可動態新增分析模組

## 資料流設計

### 標準分析流程
```
用戶問題 → 問題理解 → 股票偵測 → 時間偵測 → 意圖分類
    ↓
新聞搜尋 → 資料整合 → 報告生成 → 結果輸出
```

### 即時分析流程
```
用戶問題 → SSE 串流 → 逐步分析 → 即時回饋 → 完整報告
```

## 環境配置

### 必要環境變數
```bash
OPENAI_API_KEY=your_openai_api_key
SERPER_API_KEY=your_serper_api_key
FINLAB_API_TOKEN=your_finlab_token
```

### 可選環境變數
```bash
DEBUG_MODE=true
LOG_LEVEL=INFO
CORS_ORIGINS=*
```

## 部署說明

### 本地開發
```bash
uvicorn langgraph_app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 生產部署
```bash
uvicorn langgraph_app.main:app --host 0.0.0.0 --port $PORT
```

## 監控與維護

### 日誌記錄
- **結構化日誌**：使用 JSON 格式記錄重要事件
- **錯誤追蹤**：詳細的錯誤堆疊和上下文資訊
- **效能監控**：API 響應時間和資源使用情況

### 健康檢查
- **API 狀態**：定期檢查各 API 端點狀態
- **資料來源**：監控外部資料來源的可用性
- **系統資源**：監控 CPU、記憶體、網路使用情況

## 未來擴充

### 短期目標
- 新增更多資料來源
- 優化分析演算法
- 增強錯誤處理機制

### 長期目標
- 支援多語言
- 新增機器學習模型
- 建立用戶個人化設定
- 支援更多投資工具 