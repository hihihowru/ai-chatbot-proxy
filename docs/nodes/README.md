# nodes

## Watchlist Summary (自選股摘要)

### 完整流程概述
自選股摘要功能透過 `generate_watchlist_summary_pipeline` 整合 6 個核心模組，按順序執行：

1. **產業分布統計** → 2. **產業比較** → 3. **股價摘要** → 4. **報酬率統計分析** → 5. **異動焦點個股** → 6. **智能新聞搜尋與摘要**

**執行順序與整合**：
- 步驟 1：產生產業分布統計 section
- 步驟 1.5：產生自選股 vs 同產業指數表現 section  
- 步驟 2：產生股價摘要 section
- 步驟 3：產生報酬率統計分析 section
- 步驟 4：產生異動焦點個股 section（包含智能新聞搜尋）
- 最終整合：將所有 sections 合併為完整的自選股摘要回應

**資料流向**：
- 輸入：自選股 stock_list
- 中間處理：各模組獨立執行，產生對應 section
- 輸出：包含 4-5 個 sections 的完整 WatchlistResponse

### 1. 產業分布統計 (Industry Distribution)
- **內容組成**：統計自選股清單中各產業類別的分布。
- **資料來源**：Finlab company_basic_info。
- **流程**：
  1. 取得自選股 stock_list。
  2. 過濾 company_basic_info。
  3. 統計產業類別數量。
- **Prompt/摘要**：產業分布統計，列出各產業檔數。

### 2. 股價摘要 (Price Summary)
- **內容組成**：自選股近 1/5/20/60/240 日報酬率，表格顯示。
- **資料來源**：Finlab price:收盤價。
- **流程**：
  1. 取得自選股 stock_list。
  2. 取得收盤價歷史資料。
  3. 計算各期間報酬率。
  4. 組成表格。
- **Prompt/摘要**：各股近 1/5/20 日報酬率。

### 3. 報酬率統計分析 (Return Analysis)
- **內容組成**：統計自選股上漲/下跌檔數、平均報酬、最大漲跌幅。
- **資料來源**：Price Summary node 輸出。
- **流程**：
  1. 取得 Price Summary 結果。
  2. 統計各期間上漲/下跌/平均/最大/最小。
  3. 組成摘要與表格。
- **Prompt/摘要**：近 1/5/20 日統計分析。

### 4. 異動焦點個股 (Focus Stocks)
- **內容組成**：針對異動/焦點個股，搜尋新聞並摘要重點。
- **資料來源**：Serper API、Price Summary node。
- **流程**：
  1. 依 20 日報酬率排序，取前 5 檔。
  2. 用 Serper API 搜尋新聞。
  3. 智能生成多組關鍵字，聚焦「近期」新聞。
  4. 只回傳 allow site（domain 限定）來源。
  5. 聚合多筆新聞，主題分類（AI、重電、半導體、法人、財報、異動等），摘要顯示近一週/一月新聞數、主題、重大異動、報酬率等。
- **Prompt/摘要**：個股異動摘要、新聞主題、近期新聞聚合。

### 5. 產業比較 (Industry Comparison)
- **內容組成**：自選股與同產業指數在各期間（1/5/20/60/240日）報酬率對比，顯示領先/落後/持平。
- **資料來源**：Finlab company_basic_info、stock_index_price:收盤指數、price:收盤價。
- **流程**：
  1. 取得自選股產業類別，智能 mapping 對應產業指數（如「水泥工業」→「水泥」）。
  2. 計算個股與產業指數各期間報酬率。
  3. 標示領先/落後/無對應。
- **Prompt/摘要**：自選股 vs 同產業指數表現，產業 mapping、領先狀態。

### 6. 智能新聞搜尋與摘要 (Serper News Search & Smart Summary)
- **內容組成**：Serper API 搜尋僅限 allow site，支援 domain 參數。
- **智能關鍵字**：用 OpenAI 生成多組聚焦「近期」、「新聞」的查詢組合。
- **摘要聚合**：自動聚合多筆新聞，主題分類、近一週/一月新聞數、重大異動、法人/財報/AI/產業等主題。
- **流程**：
  1. 智能生成多組查詢關鍵字。
  2. Serper API 搜尋（domain 限定）。
  3. 聚合新聞摘要，主題分類。
- **Prompt/摘要**：近期新聞聚合摘要、主題分類。

