# detect_chart.py

## 功能說明

`detect_chart.py` 是圖表偵測模組，專門用於從自然語言問題中識別用戶想要查看的圖表類型，並對應到相應的資料表ID。此模組能夠：

1. **圖表類型識別**：識別技術分析、籌碼分析、基本面等不同圖表類型
2. **關鍵字匹配**：根據預定義的關鍵字進行智能匹配
3. **信心度計算**：計算匹配的信心度分數
4. **多圖表偵測**：支援同時偵測多個圖表類型
5. **圖表建議**：根據問題內容提供相關的圖表建議

## 主要函數

### `detect_chart(question: str) -> Optional[Dict]`
- **功能**：從問題中偵測單一最佳圖表類型
- **邏輯**：
  1. 將問題轉換為小寫
  2. 計算每個圖表類型的匹配分數
  3. 選擇分數最高的圖表類型
  4. 計算信心度
- **返回**：包含 chart_type、table_id 和 confidence 的字典

### `detect_multiple_charts(question: str) -> List[Dict]`
- **功能**：從問題中偵測多個圖表類型
- **邏輯**：
  1. 計算所有圖表類型的匹配分數
  2. 保留所有分數大於0的圖表類型
  3. 按分數降序排序
  4. 計算每個圖表的信心度
- **返回**：圖表類型列表，按分數排序

### `get_chart_suggestions(question: str) -> List[str]`
- **功能**：根據問題提供圖表建議
- **邏輯**：
  1. 偵測問題中的圖表類型
  2. 如果沒有偵測到，提供通用建議
  3. 如果偵測到，返回前3個建議
- **返回**：建議的圖表類型名稱列表

## 支援的圖表類型

### 1. 技術分析 (table_id: 735975)
```python
"技術分析": {
    "keywords": ["技術", "技術分析", "技術面", "技術指標", "K線", "KD", "MACD", "RSI", "布林通道", "均線"],
    "table_id": "735975"
}
```

### 2. 籌碼分析 (table_id: 736028)
```python
"籌碼分析": {
    "keywords": ["籌碼", "籌碼面", "法人", "外資", "投信", "自營商", "三大法人", "融資融券", "券資比"],
    "table_id": "736028"
}
```

### 3. 基本面 (table_id: 778132)
```python
"基本面": {
    "keywords": ["基本面", "財務", "營收", "獲利", "EPS", "本益比", "股價淨值比", "ROE", "ROA"],
    "table_id": "778132"
}
```

### 4. 新聞 (table_id: 778134)
```python
"新聞": {
    "keywords": ["新聞", "消息", "公告", "財報", "法說會", "股東會"],
    "table_id": "778134"
}
```

### 5. 比較分析 (table_id: 101779692)
```python
"比較分析": {
    "keywords": ["比較", "對比", "哪個好", "哪個比較好", "優劣", "排名"],
    "table_id": "101779692"
}
```

### 6. 趨勢分析 (table_id: 101779729)
```python
"趨勢分析": {
    "keywords": ["趨勢", "走勢", "方向", "漲跌", "突破", "支撐", "壓力"],
    "table_id": "101779729"
}
```

## 偵測邏輯

### 1. 關鍵字匹配
```python
# 計算每個圖表類型的匹配分數
scores = {}
for chart_type, config in CHART_MAPPING.items():
    score = 0
    for keyword in config["keywords"]:
        if keyword in question:
            score += 1
    
    if score > 0:
        scores[chart_type] = score
```

### 2. 最佳匹配選擇
```python
# 選擇分數最高的圖表類型
best_chart = max(scores.items(), key=lambda x: x[1])
chart_type = best_chart[0]
```

### 3. 信心度計算
```python
# 信心度 = 匹配分數 / 該圖表類型的總關鍵字數
confidence = best_chart[1] / len(CHART_MAPPING[chart_type]["keywords"])
```

### 4. 多圖表排序
```python
# 按分數降序排序
detected_charts.sort(key=lambda x: x["score"], reverse=True)
```

## Input/Output 範例

### 輸入範例
```python
test_questions = [
    "台積電的技術分析如何？",
    "請給我聯發科的籌碼面分析",
    "鴻海的基本面怎麼樣？",
    "最近有什麼新聞？",
    "台積電和聯發科哪個比較好？",
    "大盤的趨勢如何？",
    "請分析台積電的技術面和籌碼面"
]
```

### 輸出範例

#### 單一圖表偵測
```python
detect_chart("台積電的技術分析如何？")
# 返回: {
#     "chart_type": "技術分析",
#     "table_id": "735975",
#     "confidence": 0.2
# }

detect_chart("請給我聯發科的籌碼面分析")
# 返回: {
#     "chart_type": "籌碼分析",
#     "table_id": "736028",
#     "confidence": 0.2
# }
```

#### 多圖表偵測
```python
detect_multiple_charts("請分析台積電的技術面和籌碼面")
# 返回: [
#     {
#         "chart_type": "技術分析",
#         "table_id": "735975",
#         "confidence": 0.2,
#         "score": 2
#     },
#     {
#         "chart_type": "籌碼分析",
#         "table_id": "736028",
#         "confidence": 0.2,
#         "score": 2
#     }
# ]
```

#### 圖表建議
```python
get_chart_suggestions("台積電怎麼樣？")
# 返回: ["技術分析", "籌碼分析", "基本面"]

get_chart_suggestions("請分析台積電的技術面和籌碼面")
# 返回: ["技術分析", "籌碼分析"]
```

### 完整測試範例
```python
# 測試單一圖表偵測
question = "台積電的技術分析如何？"
result = detect_chart(question)
print(f"問題: {question}")
print(f"偵測結果: {result}")

# 測試多圖表偵測
question = "請分析台積電的技術面和籌碼面"
results = detect_multiple_charts(question)
print(f"問題: {question}")
print(f"偵測結果: {results}")

# 測試圖表建議
suggestions = get_chart_suggestions(question)
print(f"圖表建議: {suggestions}")
```

## 匹配策略

### 1. 關鍵字匹配
- **完全匹配**：檢查關鍵字是否出現在問題中
- **大小寫不敏感**：將問題轉換為小寫進行匹配
- **部分匹配**：支援關鍵字的子字串匹配

### 2. 分數計算
- **計分方式**：每個匹配的關鍵字加1分
- **總分計算**：所有匹配關鍵字的總和
- **信心度**：分數除以該圖表類型的總關鍵字數

### 3. 排序策略
- **單一圖表**：選擇分數最高的圖表類型
- **多圖表**：按分數降序排序
- **建議數量**：最多返回3個建議

## 錯誤處理

### 1. 無匹配結果
```python
# 如果沒有找到匹配，返回 None
if not scores:
    return None
```

### 2. 通用建議
```python
if not detected:
    # 如果沒有偵測到特定圖表，提供通用建議
    return ["技術分析", "籌碼分析", "基本面"]
```

### 3. 空問題處理
- 處理空字串或 None 輸入
- 提供合理的預設值
- 避免系統崩潰

## 效能優化

### 1. 字串處理優化
- 一次性轉換為小寫
- 避免重複的字串操作
- 使用高效的關鍵字匹配

### 2. 排序優化
- 使用 `sort()` 函數進行高效排序
- 按分數降序排列，優先顯示高分圖表
- 最小化重複計算

### 3. 記憶體管理
- 及時釋放臨時變數
- 避免不必要的字典複製
- 使用列表推導式提高效率

## 擴充性

### 1. 新增圖表類型
```python
# 在 CHART_MAPPING 中新增圖表類型
"新圖表類型": {
    "keywords": ["關鍵字1", "關鍵字2", "關鍵字3"],
    "table_id": "新的table_id"
}
```

### 2. 自訂匹配規則
- 可擴充正則表達式匹配
- 支援更複雜的關鍵字邏輯
- 可新增權重系統

### 3. 多語言支援
- 可擴充其他語言的關鍵字
- 支援國際化的圖表類型
- 保持一致的API介面

## 使用場景

### 1. 智能問答
- 根據用戶問題自動選擇合適的圖表
- 提供相關的圖表建議
- 支援多圖表組合分析

### 2. 資料查詢
- 根據圖表類型查詢對應的資料表
- 提供標準化的資料介面
- 支援不同分析維度的資料

### 3. 用戶體驗
- 減少用戶手動選擇圖表的步驟
- 提供智能的圖表推薦
- 支援自然語言互動

### 4. 分析報告
- 自動生成對應的分析圖表
- 支援多維度的分析報告
- 提供完整的分析視角

## 資料表對應

### 技術分析 (735975)
- 包含技術指標資料
- 支援K線、KD、MACD等指標
- 提供技術面分析資料

### 籌碼分析 (736028)
- 包含法人買賣超資料
- 支援三大法人分析
- 提供籌碼面分析資料

### 基本面 (778132)
- 包含財務指標資料
- 支援EPS、本益比等指標
- 提供基本面分析資料

### 新聞 (778134)
- 包含相關新聞資料
- 支援公告、財報等消息
- 提供新聞面分析資料

### 比較分析 (101779692)
- 包含股票比較資料
- 支援多股票對比分析
- 提供比較分析資料

### 趨勢分析 (101779729)
- 包含趨勢分析資料
- 支援走勢、突破等分析
- 提供趨勢面分析資料 