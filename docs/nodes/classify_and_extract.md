# classify_and_extract.py

## 功能說明

`classify_and_extract.py` 是投資問題理解的核心模組，整合了股票偵測、時間偵測和意圖分類功能。此模組能夠：

1. **偵測股票代號**：從問題中識別股票代號（4位數字）和公司別名
2. **偵測時間表達**：識別問題中的時間詞彙（今天、昨天、上週等）
3. **意圖分類**：使用 OpenAI 進行智能分類，判斷問題類型和投資面向
4. **關鍵字提取**：提取問題中的關鍵字，包含公司名稱、股票代號、時間、事件類型等

## 主要函數

### `detect_stocks(text: str) -> List[str]`
- **功能**：偵測文本中的股票代號
- **邏輯**：
  1. 先檢查 4 位數字格式的股票代號
  2. 再檢查公司別名對應的股票代號
- **返回**：股票代號列表

### `detect_time(question: str) -> str`
- **功能**：從問題中偵測時間表達
- **支援的時間模式**：
  - 今天/昨日/明天/前天
  - 上週/本週/下週
  - 上個月/這個月/下個月
  - 上季/本季/下季
  - 去年/今年/明年
  - 最近 N 天/週/月/年
- **返回**：標準化的時間表達

### `classify_and_extract(user_input: str, model: str = "gpt-3.5-turbo") -> Dict`
- **功能**：整合的股票偵測、時間偵測和意圖分類
- **流程**：
  1. 偵測股票代號
  2. 偵測時間表達
  3. 使用 OpenAI 進行意圖分類和關鍵字提取
  4. 整合所有資訊返回結果

## Prompt 設計

### 問題分類架構
系統將問題分為 7 大類：

1. **個股分析**：公司介紹、基本面分析、籌碼面分析、技術面分析、個股資訊查找、價格評論
2. **選股建議**：篩選條件選股、法人追蹤選股、籌碼追蹤選股、強勢股/起漲股/題材熱股
3. **盤勢分析**：大盤走勢分析、類股輪動/熱門族群、產業、國際股市、美股、期貨、總經
4. **比較分析**：個股比較、類股比較、同產業走勢比較
5. **金融知識詢問**：制度說明、指標定義
6. **複雜查詢任務**：多層條件查詢、結構化資料對照、模擬選股/假設回測問題
7. **無效問題**：無明確投資內容、預測性問題、ChatGPT 自由發揮/幽默提問

### 投資面向
- **基本面**：財務指標、營收獲利、產業地位等
- **技術面**：K線、均線、技術指標、價量關係等
- **籌碼面**：法人動向、大戶散戶、股權分散等
- **沒有特別**：問題沒有特別偏向某個面向

## Input/Output 範例

### 輸入範例
```python
user_input = "華碩前天漲停板但今天下跌，是什麼原因"
```

### 輸出範例
```json
{
  "category": "個股分析",
  "subcategory": ["價格評論"],
  "view_type": ["籌碼面", "技術面"],
  "keywords": ["華碩", "2357", "漲停", "下跌", "原因"],
  "company_name": "華碩",
  "stock_id": "2357",
  "time_info": "day_before_yesterday",
  "event_type": "漲停"
}
```

### 測試案例
```python
test_cases = [
    "華碩前天漲停板但今天下跌，是什麼原因",
    "台積電這季財報怎麼樣？",
    "請給我2330的法人買賣超"
]
```

## 資料來源

- **股票別名字典**：`data/stock_alias_dict.json`
- **OpenAI API**：用於意圖分類和關鍵字提取

## 錯誤處理

- **JSON 解析失敗**：返回基本資訊結構
- **API 錯誤**：返回預設值並記錄錯誤
- **股票偵測失敗**：返回空字串

## 擴充性

- 可新增更多時間模式
- 可擴充股票別名字典
- 可調整問題分類架構
- 可支援更多投資面向 