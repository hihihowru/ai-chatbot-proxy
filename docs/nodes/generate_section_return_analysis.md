# generate_section_return_analysis.py

## 功能說明

`generate_section_return_analysis.py` 是報酬率統計分析模組，專門用於分析自選股的整體報酬率統計資料。此模組能夠：

1. **統計分析**：計算各期間的上漲/下跌家數、平均報酬率
2. **極值分析**：找出最大漲幅和最大跌幅的股票
3. **表格呈現**：以結構化表格顯示統計結果
4. **資料整合**：整合來自股價摘要模組的資料
5. **視覺化準備**：提供資料供前端繪製圖表

## 主要函數

### `generate_return_analysis_section(price_data: List[Dict]) -> Dict[str, Any]`
- **功能**：產生報酬率統計分析 section
- **參數**：
  - `price_data`: 股價摘要資料（來自 generate_price_summary_section）
- **返回**：包含 success、section、analysis_data 的字典

## 分析期間

### 統計期間
- **1日報酬**：過去一日漲跌統計
- **5日報酬**：過去一週漲跌統計
- **20日報酬**：過去一月漲跌統計

### 統計指標
- **上漲家數**：報酬率 > 0 的股票數量
- **下跌家數**：報酬率 < 0 的股票數量
- **平均報酬率**：所有股票的平均報酬率
- **最大漲幅**：最高報酬率及其對應股票
- **最大跌幅**：最低報酬率及其對應股票

## Input/Output 範例

### 輸入範例
```python
price_data = [
    {
        "stock_id": "2330",
        "company_name": "台積電",
        "1日報酬": 1.2,
        "5日報酬": 3.5,
        "20日報酬": 8.7
    },
    {
        "stock_id": "2303",
        "company_name": "聯電",
        "1日報酬": -0.8,
        "5日報酬": 2.1,
        "20日報酬": 5.3
    }
]
```

### 輸出範例
```json
{
  "success": true,
  "section": {
    "title": "報酬率統計分析",
    "content": "📊 報酬率統計分析\n\t•\t**過去一日：**上漲 1 檔，下跌 1 檔\n\t•\t平均一週漲幅：+2.8%\n\t•\t**最大漲幅：**台積電（+3.5%，5 日）\n\t•\t**最大漲幅：**台積電（+8.7%，20 日）",
    "cards": [
      {
        "title": "報酬率統計",
        "content": "📊 報酬率統計分析...",
        "type": "text"
      },
      {
        "title": "詳細統計表格",
        "content": "報酬率統計詳情\n\n期間\t上漲檔數\t下跌檔數\t平均報酬\t最大漲幅\t最大跌幅\n1日\t1\t1\t+0.2%\t+1.2%\t-0.8%\n5日\t2\t0\t+2.8%\t+3.5%\t+2.1%\n20日\t2\t0\t+7.0%\t+8.7%\t+5.3%",
        "type": "table",
        "data": {
          "1日報酬": {
            "up_count": 1,
            "down_count": 1,
            "avg_return": 0.2,
            "max_return": 1.2,
            "min_return": -0.8,
            "max_stock": {"stock_id": "2330", "company_name": "台積電"},
            "min_stock": {"stock_id": "2303", "company_name": "聯電"}
          }
        }
      }
    ],
    "sources": [
      {
        "name": "Finlab 收盤價資料",
        "url": "https://finlab.tw/",
        "description": "台股收盤價歷史資料"
      }
    ]
  },
  "analysis_data": {
    "1日報酬": {
      "up_count": 1,
      "down_count": 1,
      "flat_count": 0,
      "avg_return": 0.2,
      "max_return": 1.2,
      "min_return": -0.8,
      "max_stock": {"stock_id": "2330", "company_name": "台積電"},
      "min_stock": {"stock_id": "2303", "company_name": "聯電"},
      "total_count": 2
    }
  }
}
```

## 統計邏輯

### 資料處理
1. **有效資料篩選**：只統計有報酬率資料的股票
2. **數值計算**：使用 numpy 進行統計計算
3. **極值識別**：找出最大漲幅和最大跌幅的股票
4. **格式化輸出**：保留一位小數，正數前加 "+" 號

### 統計公式
- **上漲家數**：`np.sum(returns > 0)`
- **下跌家數**：`np.sum(returns < 0)`
- **平均報酬率**：`np.mean(returns)`
- **最大漲幅**：`np.max(returns)`
- **最大跌幅**：`np.min(returns)`

## 表格格式

### 統計表格結構
```
期間    上漲檔數    下跌檔數    平均報酬    最大漲幅    最大跌幅
1日     1          1          +0.2%       +1.2%       -0.8%
5日     2          0          +2.8%       +3.5%       +2.1%
20日    2          0          +7.0%       +8.7%       +5.3%
```

### 文字摘要格式
```
📊 報酬率統計分析
    • 過去一日：上漲 1 檔，下跌 1 檔
    • 平均一週漲幅：+2.8%
    • 最大漲幅：台積電（+3.5%，5 日）
```

## 錯誤處理

### 資料驗證
- 檢查 price_data 是否為空
- 驗證資料格式是否正確
- 處理無效的報酬率資料

### 計算異常
- 處理 NaN 或無效數值
- 捕獲統計計算錯誤
- 記錄錯誤訊息

## 擴充性

### 新增統計期間
- 可調整 periods 列表
- 新增更多時間區間
- 自訂統計指標

### 視覺化支援
- 提供結構化資料供前端繪圖
- 支援多種圖表類型
- 可擴充互動功能

### 分析深度
- 可新增更多統計指標
- 支援分組分析
- 加入趨勢分析 