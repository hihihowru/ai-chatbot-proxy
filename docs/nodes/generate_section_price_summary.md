# generate_section_price_summary.py

## 功能說明

`generate_section_price_summary.py` 是股價摘要模組，專門用於計算自選股的報酬率並以表格形式呈現。此模組能夠：

1. **股價資料取得**：從 Finlab 取得收盤價歷史資料
2. **報酬率計算**：計算 1日、5日、20日、60日、240日報酬率
3. **表格呈現**：以結構化表格顯示各股票的報酬率
4. **資料傳遞**：提供原始股價資料供其他模組使用
5. **錯誤處理**：處理資料不足或連線失敗的情況

## 主要函數

### `generate_price_summary_section(stock_list: List[int]) -> Dict[str, Any]`
- **功能**：產生股價摘要 section，計算報酬率並輸出表格
- **參數**：
  - `stock_list`: 自選股清單（數字列表）
- **返回**：包含 success、section、price_data 的字典

## 資料來源

### Finlab 資料庫
- **收盤價資料**：`data.get('price:收盤價')`
- **公司基本資訊**：`data.get('company_basic_info')`
- **API Token**：需要有效的 Finlab API Token

## 報酬率計算邏輯

### 計算期間
- **1日報酬**：與前一日收盤價比較
- **5日報酬**：與前5日收盤價比較
- **20日報酬**：與前20日收盤價比較
- **60日報酬**：與前60日收盤價比較
- **240日報酬**：與前240日收盤價比較

### 計算公式
```
報酬率 = (最新價格 - 歷史價格) / 歷史價格 × 100%
```

### 資料品質檢查
- 至少需要 20 天資料才進行計算
- 處理價格為 0 或 NaN 的情況
- 跳過資料不足的股票

## Input/Output 範例

### 輸入範例
```python
stock_list = [2303, 2330, 2610, 2376, 2317]
```

### 輸出範例
```json
{
  "success": true,
  "section": {
    "title": "股價摘要",
    "content": "股價摘要（變動趨勢）\n\n統計區間：1日 / 5日 / 20日 / 60日 / 240日 報酬率\n股票代號\t公司名稱\t1日報酬\t5日報酬\t20日報酬\t60日報酬\t240日報酬\n2330\t台積電\t+1.2%\t+3.5%\t+8.7%\t+15.2%\t+25.8%\n2303\t聯電\t-0.8%\t+2.1%\t+5.3%\t+12.4%\t+18.9%",
    "cards": [
      {
        "title": "股價變動趨勢",
        "content": "股價摘要（變動趨勢）...",
        "type": "table",
        "data": [
          {
            "stock_id": "2330",
            "company_name": "台積電",
            "close": 850.0,
            "close_date": "2025-01-15",
            "change_1d": 1.2,
            "change_1w": 3.5,
            "change_1m": 8.7,
            "change_1y": 25.8,
            "1日報酬": 1.2,
            "5日報酬": 3.5,
            "20日報酬": 8.7,
            "60日報酬": 15.2,
            "240日報酬": 25.8
          }
        ]
      }
    ],
    "sources": [
      {
        "name": "Finlab 收盤價資料",
        "url": "https://finlab.tw/",
        "description": "台股收盤價歷史資料"
      }
    ]
  },
  "price_data": [
    {
      "stock_id": "2330",
      "company_name": "台積電",
      "close": 850.0,
      "close_date": "2025-01-15",
      "change_1d": 1.2,
      "change_1w": 3.5,
      "change_1m": 8.7,
      "change_1y": 25.8,
      "1日報酬": 1.2,
      "5日報酬": 3.5,
      "20日報酬": 8.7,
      "60日報酬": 15.2,
      "240日報酬": 25.8
    }
  ]
}
```

## 表格格式

### 表頭結構
```
股票代號    公司名稱    1日報酬    5日報酬    20日報酬    60日報酬    240日報酬
```

### 資料格式
- **股票代號**：4位數字
- **公司名稱**：從 Finlab 基本資訊取得
- **報酬率**：保留一位小數，正數前加 "+" 號
- **無資料**：顯示 "N/A"

## 錯誤處理

### Finlab 連線失敗
- 檢查 API Token 是否有效
- 記錄連線錯誤訊息
- 返回失敗狀態

### 資料不足
- 檢查股票是否有足夠的歷史資料
- 跳過資料不足的股票
- 記錄警告訊息

### 計算錯誤
- 處理價格為 0 或 NaN 的情況
- 捕獲個別股票的計算異常
- 繼續處理其他股票

## 資料傳遞

### 供其他模組使用
- **price_data**：包含完整的股價和報酬率資料
- **格式**：結構化字典列表
- **用途**：供報酬率統計分析和異動焦點個股模組使用

### 資料結構
```python
{
  "stock_id": "股票代號",
  "company_name": "公司名稱",
  "close": "最新收盤價",
  "close_date": "最新日期",
  "change_1d": "1日漲跌幅",
  "change_1w": "1週漲跌幅",
  "change_1m": "1月漲跌幅",
  "change_1y": "1年漲跌幅",
  "1日報酬": "1日報酬率",
  "5日報酬": "5日報酬率",
  "20日報酬": "20日報酬率",
  "60日報酬": "60日報酬率",
  "240日報酬": "240日報酬率"
}
```

## 擴充性

### 新增報酬率期間
- 可調整 periods 列表
- 修改計算邏輯
- 更新表格格式

### 自訂表格格式
- 可調整欄位順序
- 修改數值格式化
- 新增其他統計指標

### 資料來源擴充
- 可支援其他資料來源
- 整合多個資料庫
- 增加資料品質檢查 