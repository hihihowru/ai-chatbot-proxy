# detect_stock.py

## 功能說明

`detect_stock.py` 是股票偵測模組，專門用於從自然語言文本中識別股票代號和公司別名。此模組能夠：

1. **股票代號偵測**：識別 4 位數字的股票代號
2. **公司別名匹配**：根據股票別名字典進行精確和模糊匹配
3. **多股票偵測**：從一句話中識別多個股票
4. **優先級排序**：按照匹配長度和位置進行排序
5. **股票名稱查詢**：根據股票代號查詢中文股名

## 主要函數

### `detect_stock(text: str) -> Optional[str]`
- **功能**：偵測單一股票代號
- **邏輯**：
  1. 先進行完全等於比對（優先級最高）
  2. 再進行包含比對
- **返回**：股票代號或 None

### `detect_stocks(text: str) -> List[str]`
- **功能**：偵測所有股票代號
- **邏輯**：
  1. 先檢查 4 位數字格式的股票代號
  2. 再檢查公司別名匹配
  3. 按照匹配長度和位置排序
  4. 去除重複股票代號
- **返回**：股票代號列表

### `get_stock_name_by_id(stock_id: str) -> Optional[str]`
- **功能**：根據股票代號查詢中文股名
- **邏輯**：取 stock_alias_dict.json 中該代號的第一個非數字別名
- **返回**：中文股名或 None

## 資料來源

### 股票別名字典
- **檔案路徑**：`data/stock_alias_dict.json`
- **格式**：
```json
{
  "2330": ["台積電", "TSMC", "2330"],
  "2303": ["聯電", "UMC", "2303"],
  "2317": ["鴻海", "Foxconn", "2317"]
}
```

### 反查表建立
```python
alias_to_id = {}
for stock_id, aliases in stock_dict.items():
    for alias in aliases:
        alias_to_id[alias] = stock_id
```

## 偵測邏輯

### 1. 數字格式偵測
```python
# 使用正則表達式匹配 4 位數字
stock_codes = re.findall(r'\b\d{4}\b', text)
```

### 2. 別名匹配策略
- **完全等於比對**：優先級最高
- **包含比對**：次優先級
- **長度優先**：更長的別名優先匹配
- **位置排序**：相同長度按位置排序

### 3. 去重邏輯
- 使用 `seen_stocks` 集合避免重複
- 數字格式優先，別名匹配後添加

## Input/Output 範例

### 輸入範例
```python
test_cases = [
    "我想查台積電的技術線圖",
    "請給我2330的法人買賣超",
    "亞泥最近怎麼樣？",
    "請查詢1301的新聞",
    "台積電和聯發科哪個比較好？",
    "2330、2454、2317這三檔股票"
]
```

### 輸出範例
```python
# 單一股票偵測
detect_stock("我想查台積電的技術線圖")  # 返回: "2330"

# 多股票偵測
detect_stocks("台積電和聯發科哪個比較好？")  # 返回: ["2330", "2454"]
detect_stocks("2330、2454、2317這三檔股票")  # 返回: ["2330", "2454", "2317"]

# 股票名稱查詢
get_stock_name_by_id("2330")  # 返回: "台積電"
```

### 測試結果
```
輸入: 我想查台積電的技術線圖 -> 偵測: ['2330']
輸入: 請給我2330的法人買賣超 -> 偵測: ['2330']
輸入: 亞泥最近怎麼樣？ -> 偵測: ['1102']
輸入: 請查詢1301的新聞 -> 偵測: ['1301']
輸入: 台積電和聯發科哪個比較好？ -> 偵測: ['2330', '2454']
輸入: 2330、2454、2317這三檔股票 -> 偵測: ['2330', '2454', '2317']
```

## 匹配優先級

### 1. 數字格式優先
- 4 位數字股票代號具有最高優先級
- 直接從 stock_dict 中驗證有效性

### 2. 別名匹配順序
1. **完全等於比對**：`text.lower() == alias.lower()`
2. **包含比對**：`alias.lower() in text.lower()`
3. **長度排序**：更長的別名優先匹配
4. **位置排序**：相同長度按在文本中的位置排序

### 3. 去重策略
- 數字格式股票代號優先添加
- 別名匹配的股票代號按排序後順序添加
- 使用集合避免重複

## 錯誤處理

### 1. 檔案讀取錯誤
- 檢查 stock_alias_dict.json 是否存在
- 處理 JSON 解析錯誤
- 提供預設空字典

### 2. 匹配失敗
- 返回空列表或 None
- 記錄警告訊息
- 不影響其他功能

### 3. 資料格式錯誤
- 驗證股票代號格式
- 處理無效的別名資料
- 跳過格式錯誤的項目

## 效能優化

### 1. 預載入字典
- 模組載入時一次性讀取股票別名字典
- 建立反查表提高查詢效率
- 避免重複檔案讀取

### 2. 排序優化
- 使用 `sorted()` 函數進行高效排序
- 按長度降序排列，優先匹配長別名
- 最小化重複計算

### 3. 記憶體管理
- 使用集合進行去重操作
- 避免不必要的列表複製
- 及時釋放臨時變數

## 擴充性

### 1. 新增股票別名
- 直接修改 stock_alias_dict.json
- 支援動態重新載入
- 保持向後相容性

### 2. 自訂匹配規則
- 可擴充正則表達式模式
- 支援自訂優先級邏輯
- 可新增特殊匹配規則

### 3. 多語言支援
- 支援英文別名匹配
- 可擴充其他語言別名
- 保持大小寫不敏感

## 使用場景

### 1. 問題理解
- 在用戶問題中識別股票代號
- 為後續分析提供股票資訊
- 支援多股票比較分析

### 2. 資料查詢
- 根據股票代號查詢相關資料
- 支援模糊匹配提高用戶體驗
- 處理各種表達方式

### 3. 報告生成
- 在分析報告中標示股票資訊
- 提供股票名稱和代號對應
- 支援多股票分析報告 